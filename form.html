<!-- Inside your <script> section -->
<script>
  const rollToName = {
    "1": "CHIRAG RANA", "2": "SHARANJIT SINGH", "3": "ANEESH KUMAR", // etc.
  };
  const ADMIN_USERNAME = "admin";
  const ADMIN_PASSWORD = "Prabh@77102";
  let todayCode = "";

  function disableFields(disabled) {
    document.getElementById('roll').disabled = disabled;
    document.getElementById('name').disabled = disabled;
    document.getElementById('confirm').disabled = disabled;
    document.querySelector('button[type="submit"]').disabled = disabled;
  }

  function verifyAdmin() {
    const user = document.getElementById('adminUser').value.trim();
    const pass = document.getElementById('adminPass').value.trim();
    const panel = document.getElementById('adminPanel');
    if (user === ADMIN_USERNAME && pass === ADMIN_PASSWORD) {
      panel.classList.remove('hidden');
      document.getElementById('adminLogin').classList.add('hidden');
    } else {
      alert("Invalid admin credentials!");
    }
  }

  function updateCode() {
    const newCode = document.getElementById('newCode').value.trim().toUpperCase();
    const status = document.getElementById('adminStatus');
    if (newCode.length !== 3 || !/^[A-Z0-9]+$/.test(newCode)) {
      status.style.color = "orange";
      status.textContent = "Code must be 3 letters/numbers.";
      return;
    }
    fetch("https://script.google.com/macros/s/AKfycbwoGxLlp2a0pOPsBPCDZvXTESP7votu96ItqlGPwDx1I9ZHSnjr7WfwWpIH8a4DUxP5/exec", {
      method: "POST",
      body: JSON.stringify({ code: newCode }),
      headers: { "Content-Type": "application/json" }
    })
      .then(res => res.text())
      .then(response => {
        todayCode = newCode;
        document.getElementById('code').value = newCode;
        disableFields(false);
        status.style.color = "lightgreen";
        status.textContent = "Code updated successfully.";
      })
      .catch(err => {
        status.style.color = "red";
        status.textContent = "Failed to update code.";
      });
  }

  window.onload = function () {
    setTimeout(() => {
      document.getElementById('preloader').classList.add('fade-out');
      document.getElementById('main-content').classList.add('visible');
    }, 1500);

    const rollDropdown = document.getElementById('roll');
    Object.keys(rollToName).sort((a, b) => a - b).forEach(roll => {
      const option = document.createElement('option');
      option.value = roll;
      option.textContent = roll;
      rollDropdown.appendChild(option);
    });

    rollDropdown.addEventListener('change', e => {
      document.getElementById('name').value = rollToName[e.target.value] || '';
    });

    // âœ… GET today's code
    fetch("https://script.google.com/macros/s/AKfycbwoGxLlp2a0pOPsBPCDZvXTESP7votu96ItqlGPwDx1I9ZHSnjr7WfwWpIH8a4DUxP5/exec")
      .then(res => res.text())
      .then(code => {
        todayCode = code.trim();
        disableFields(true);
      });

    document.getElementById('attendanceForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const now = new Date();
      const ISTTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
      const hour = ISTTime.getHours();
      const minute = ISTTime.getMinutes();
      if (!(hour === 13 && minute >= 30 || hour === 14 && minute <= 15)) {
        alert("Form accessible only between 1:30 PM and 2:15 PM IST");
        return;
      }

      const codeInput = document.getElementById('code').value.trim();
      if (codeInput !== todayCode) {
        document.getElementById('codeError').classList.remove('hidden');
        return;
      }
      document.getElementById('codeError').classList.add('hidden');
      alert("Attendance submitted successfully.");
    });

    document.getElementById('code').addEventListener('input', function () {
      const inputCode = this.value.trim();
      if (inputCode === todayCode) {
        document.getElementById('codeError').classList.add('hidden');
        disableFields(false);
      } else {
        disableFields(true);
        document.getElementById('codeError').classList.remove('hidden');
      }
    });
  };
</script>
